name: Flippy-Openwrt

on:
  schedule:
    - cron: '0 23 * * 5'
  watch:
    types: started

env:
  REPO_FLODER: openwrt
  BUILD_UNIFREQ: true
  UPLOAD_RELEASE: true
  UPLOAD_ARTIFACT: false
  UPLOAD_COWTRANSFER: false
  TARGET_DEVICE: armvirt_64_Default

jobs:
  Flippy-Openwrt:
    name: Flippy-Openwrt-${{matrix.target}}
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id

    env:
      KERNEL_VERSION: ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target:
          - 5.18.4-flippy-73+
          - 5.17.15-flippy-73+
          - 5.15.47-flippy-73+o

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: éƒ¨ç½²
      id: organize
      run: |
        k=`curl -Ls github.com/hong0980/Actions-OpenWrt/releases | awk -F'"' '/download.*armvirt.*rootf/{print $2}' | head -1`
        u=`curl -Ls github.com/hong0980/Flippy-Openwrt/releases  | awk -F'"' '/download.*armvirt.*rootf/{print $2}' | head -1`
        if [[ $k =~ armvirt || $u =~ armvirt ]]; then
          ([[ $k =~ armvirt ]] && wget -q github.com/$k) || ([[ $u =~ armvirt ]] && wget -q github.com/$u)
          sudo ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
          ( sudo apt update
          sudo apt -y --no-upgrade --no-install-recommends install git p7zip p7zip-full zip unzip gzip xz-utils pigz zstd ) &
          echo "::set-output name=status::success"
        else
          ( sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs gcc-multilib g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx-ucl libelf-dev autoconf automake libtool autopoint device-tree-compiler ccache xsltproc rename antlr3 gperf wget curl swig rsync
          sudo -E apt-get -qq purge azure-cli ghc* zulu* hhvm llvm* firefox powershell openjdk* dotnet* google* mysql* php* android*
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime ) &
          echo "PARTSIZE=700" >> $GITHUB_ENV
          echo "VERSION=plus" >> $GITHUB_ENV
          echo "IP=192.168.2.1" >> $GITHUB_ENV
          echo "REPO_BRANCH=openwrt-18.06-k5.4" >> $GITHUB_ENV
          echo "TARGET_DEVICE=armvirt_64_Default" >> $GITHUB_ENV
          curl -fsSL git.io/J6IXO | /bin/bash
        fi

    - name: ä¸‹è½½
      if: steps.organize.outputs.status != 'success' && !cancelled()
      run: |
        cd $REPO_FLODER
        make download -j16
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "ARCH=$(awk -F'"' '/^CONFIG_TARGET_BOARD/{print $2}' .config)" >>$GITHUB_ENV

    - name: Cache
      if: steps.organize.outputs.status != 'success'
      uses: klever1988/cachewrtbuild@test
      continue-on-error: true
      with:
        ccache: 'true'
        mixkey: ${{env.ARCH}}
        prefix: ${{github.workspace}}/${{env.REPO_FLODER}}

    - name: ç¼–è¯‘
      id: compile
      if: steps.organize.outputs.status != 'success' && !cancelled()
      run: |
        cd $REPO_FLODER
        make -j$(($(nproc)+1)) || make -j1 V=s || { echo "ç¼–è¯‘å¤±è´¥"; exit 1; }
        echo "::set-output name=status::success"
        echo "======================="
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        echo "======================="
        df -hT
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin
        ls bin/targets/*/*/

    - name: ç­›é€‰
      id: firmware
      if: steps.organize.outputs.status == 'success' || steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        mkdir firmware
        git clone -q https://github.com/unifreq/openwrt_packit opt/openwrt_packit
        if [[ `ls *.tar.gz` ]]; then
          echo firmware opt/openwrt_packit | xargs -n 1 cp -rv *.tar.gz
        else
          echo firmware opt/openwrt_packit | xargs -n 1 cp -rv $REPO_FLODER/bin/targets/*/*/*.tar.gz
        fi
        echo "::set-output name=status::success"
        echo "FIRMWARE=$GITHUB_WORKSPACE/firmware" >>$GITHUB_ENV
        echo "STRDATE=$(TZ=UTC-8 date +%Y-%m-%d)" >>$GITHUB_ENV
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        RANDOM=$$$(date +%s); rand=$[$RANDOM % ${#Emoji[@]}]
        echo "EMOJI=${Emoji[$rand]}" >>$GITHUB_ENV

    - name: æ‰“åŒ…
      if: steps.firmware.outputs.status == 'success' && env.BUILD_UNIFREQ == 'true' && !cancelled()
      id: unifreq
      run: |
        cd opt/openwrt_packit || exit
        [[ -e files/luci-admin-status-index-html.patch ]] && \
        mv -fv $GITHUB_WORKSPACE/luci-admin-status-index-html.patch files
        rm files/luci-admin-status-index-html-02.patch
        sed -i 's/lean & lienol/immortalwrt/' public_funcs
        sed -i '{
          s|WHOAMI=.*|WHOAMI="hong0980"|
          s|OPENWRT_VER=.*|OPENWRT_VER="18.06-k5.4"|
          s|KERNEL_VERSION=.*|KERNEL_VERSION='"$KERNEL_VERSION"'|g
          s|KERNEL_PKG_HOME=.*|KERNEL_PKG_HOME='"$GITHUB_WORKSPACE/opt/kernel"'|
        }' make.env
        for x in `ls mk*.sh | grep -v "dockerimg"`; do
          sed -i '{
            s|OP_ROOT_TGZ=.*|OP_ROOT_TGZ='"$(ls *.tar.gz)"'|
            s|TGT_IMG=.*|TGT_IMG="${WORK_DIR}/openwrt_${OPENWRT_VER}_${SOC}_${BOARD}_k${KERNEL_VERSION}${SUBVER}_$(date +%Y-%m-%d).img"|
          }' $x
          PLATFORM=`awk -F= '/PLATFORM=/{print $2}' $x`
          [[ -e ../kernel/boot-${KERNEL_VERSION}.tar.gz ]] || \
          wget -q raw.githubusercontent.com/hong0980/kernel/master/boot-${KERNEL_VERSION}.tar.gz -P ../kernel
          [[ -e ../kernel/modules-${KERNEL_VERSION}.tar.gz ]] || \
          wget -q raw.githubusercontent.com/hong0980/kernel/master/modules-${KERNEL_VERSION}.tar.gz -P ../kernel
          [[ -e ../kernel/dtb-${PLATFORM}-${KERNEL_VERSION}.tar.gz ]] || \
          wget -q raw.githubusercontent.com/hong0980/kernel/master/dtb-${PLATFORM}-${KERNEL_VERSION}.tar.gz -P ../kernel
          sudo ./$x && {
            sudo gzip -9 output/*.img
            sudo mv -v output/*.img.gz ${FIRMWARE} || true
            echo "::set-output name=status::success"
          }
        done
        md5sum ${FIRMWARE}/* | sed "s|${FIRMWARE}/||" >>${FIRMWARE}/${KERNEL_VERSION}_md5.txt

    - name: packages
      if: steps.organize.outputs.status != 'success' && !cancelled()
      uses: actions/upload-artifact@v2.2.4
      with:
        name: OpenWrt_package
        path: ${{env.REPO_FLODER}}/bin/packages/

    - name: ä¸Šä¼  openwrt-armvirt-64-default-rootfs
      if: steps.organize.outputs.status != 'success' && !cancelled()
      uses: actions/upload-artifact@v2.2.4
      with:
        name: openwrt-armvirt-64-default-rootfs
        path: ${{env.REPO_FLODER}}/bin/targets/*/*/*.tar.gz

    - name: ä¸Šä¼ åˆ°WeTransfer
      if: env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      continue-on-error: true
      run: |
        [ -e $REPO_FLODER/.config ] && sed -e '/^$/d;/DEFAULT/d;/i18n/d' $REPO_FLODER/.config > ${FIRMWARE}/n1-config.txt
        [ -d $REPO_FLODER/bin/packages ] && tar -zcf packages.tar.gz $REPO_FLODER/bin/packages/ && \
        cp -Rfv packages.tar.gz ${FIRMWARE}
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "::set-output name=url::$(grep https wetransfer.log | cut -f3 -d" ")"

    - name: ä¸Šä¼ åˆ° release
      if: env.UPLOAD_RELEASE == 'true' && steps.unifreq.outputs.status == 'success' && !cancelled()
      uses: svenstaro/upload-release-action@v2
      with:
        file_glob: true
        overwrite: true
        tag: ${{env.STRDATE}}
        file: ${{env.FIRMWARE}}/*
        repo_token: ${{secrets.GITHUB_TOKEN}}
        release_name: ${{env.STRDATE}} ${{env.EMOJI}} è‡ªåŠ¨å‘å¸ƒ ${{env.EMOJI}}
        body: |
          - âœ¨âœ¨âœ¨âœ¨
          - åŸºäºflippy(https://github.com/unifreq/openwrt_packit )å¤§çš„è„šæœ¬æ‰“åŒ…å›ºä»¶ï¼Œ
          - é€‚é…çš„æœºå‹æœ‰ï¼šå¾®åŠ äº‘ã€è´å£³äº‘ã€æˆ‘å®¶äº‘ã€N1ã€S905x3ï¼ˆåŒ…æ‹¬å¸¸è§çš„hk1ã€h96ã€x96ç­‰ç›’å­ï¼‰ï¼Œ
          - ç« é±¼æ˜Ÿçƒã€s922xï¼ˆç›®å‰æ”¯æŒGT-Kingã€GT-King Proä¸¤æ¬¾ç›’å­ï¼‰ ç­‰ï¼
          - +çš„å†…æ ¸ç‰ˆæœ¬è¾ƒæ–°ï¼›+oçš„ç‰ˆæœ¬ç›¸å¯¹+çš„å†…æ ¸æ›´ç¨³å®šï¼ˆæ¨èä½¿ç”¨ï¼‰ã€‚
          - é»˜è®¤IPï¼š192.168.2.100 é»˜è®¤å¯†ç ï¼šwin3gp
          - å½“å‰ä½¿ç”¨â¦immortalwrtçš„ä¸»æºç (https://github.com/immortalwrt/immortalwrt openwrt-18.06-k5.4åˆ†æ”¯)
          - ä¸€ã€Amlogicç³»åˆ—ç›’å­ï¼ŒåŒ…æ‹¬ N1ã€ç« é±¼æ˜Ÿçƒã€S905X2å¤–è´¸ç›’å­ã€S905X3å¤–è´¸ç›’å­ã€S922Xå¤–è´¸ç›’å­
          -   ç¬¬ä¸€æ¬¡åˆ·æœºï¼ˆä»Uç›˜æˆ–TFå¡å¯åŠ¨ä¹‹åï¼‰ï¼š
          -   cd root && ./install-to-emmc.sh æˆ–è€…ï¼š /root/install-to-emmc.sh æˆ–è€…ï¼š openwrt-install-amlogic (65ç‰ˆæœ¬æ–°å¢çš„å‘½ä»¤ï¼‰
          -   åœ¨çº¿å‡çº§ï¼Œå…ˆæŠŠ update-amlogic-openwrt.sh ä»¥åŠé•œåƒæ–‡ä»¶ xxxxxxxxxxxxxxxxxxxxxxxxx.imgç”¨winscpå·¥å…·ä¸Šä¼ è‡³/mnt/mmcblk2p4, ç„¶åï¼š
          -   cd mnt/mmcblk2p4 && chmod 755 update-amlogic-openwrt.sh
          -   ./update-amlogic-openwrt.sh xxxxxxxxxxxxxxxxxxxxxxxxxx.img (æˆ–è€…ç”¨æ™¶æ™¨å®ç›’ä¹Ÿå¯ä»¥æ›´æ–°ï¼‰
          - äºŒã€rk3328ç›’å­ï¼ŒåŒ…æ‹¬è´å£³äº‘ã€æˆ‘å®¶äº‘
          -   ç¬¬ä¸€æ¬¡åˆ·æœºï¼šçº¿åˆ·
          -   åœ¨çº¿å‡çº§ï¼Œå…ˆæŠŠ update-beikeyun(æˆ–l1pro)-openwrt.sh ä»¥åŠé•œåƒæ–‡ä»¶ xxxxxxxxxxxxxxxxxxxxxxxxx.imgç”¨winscpå·¥å…·ä¸Šä¼ è‡³/mnt/mmcblk0p4, ç„¶åï¼š
          -   cd /mnt/mmcblk0p4 && chmod 755 update-beikeyun(æˆ–l1pro)-openwrt.sh
          -   ./update-beikeyun(æˆ–l1pro)-openwrt.sh xxxxxxxxxxxxxxxxxxxxxxxxxx.img ï¼ƒ æ³¨ï¼šbeikeyunä»£è¡¨è´å£³äº‘ï¼Œ l1proä»£è¡¨æˆ‘å®¶äº‘  
          -   æ³¨æ„ï¼šupdate-beikeyun(æˆ–l1pro)-openwrt.shä¸€èˆ¬éšå›ºä»¶åŒæ—¶å‘å¸ƒï¼Œåœ¨.7zåŒ…é‡Œé¢ï¼Œæ¯æ¬¡å‡çº§æœ€å¥½éƒ½ç”¨æœ€æ–°ç‰ˆçš„updateè„šæœ¬ã€€ã€€
          -   æˆ–è€…ï¼š openwrt-update-rockchip xxxxxxxxxxxxxxxxxxxxxxxxxx.imgã€€
          -   æˆ–è€…ç”¨æ™¶æ™¨å®ç›’æ›´æ–°
          - ä¸‰ã€allwinner H6ï¼ŒåŒ…æ‹¬å¾®åŠ äº‘åˆ·æœºå’Œå‡çº§ï¼šç•¥ï¼ˆæœ‰å¾®åŠ äº‘çš„åŸºæœ¬éƒ½ä¼šäº†ï¼Œæ²¡æœ‰çš„ä¹Ÿä¹°ä¸åˆ°ï¼‰
          - âœ¨âœ¨âœ¨âœ¨
